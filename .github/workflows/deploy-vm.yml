name: Deploy VM

on:
  workflow_dispatch:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH
        shell: bash
        run: |
          set -e
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/github_actions
          chmod 600 ~/.ssh/github_actions
          ssh-keyscan -H "${{ secrets.VM_HOST }}" >> ~/.ssh/known_hosts

      - name: Deploy to VM (pull + install + restart)
        shell: bash
        run: |
          set -e
          ssh -i ~/.ssh/github_actions "${{ secrets.VM_USER }}@${{ secrets.VM_HOST }}" <<'SSH'
          set -e
          cd /home/roteiro_ds/AUTOTRADER-PRO
          git fetch --all
          git reset --hard origin/main
          npm ci --omit=dev
          sudo systemctl restart autotrader-pro.service
          SSH

      - name: TESTE 1 - Service ativo
        shell: bash
        run: |
          set -e
          ssh -i ~/.ssh/github_actions "${{ secrets.VM_USER }}@${{ secrets.VM_HOST }}" \
            "sudo systemctl is-active --quiet autotrader-pro.service && echo OK_SERVICE"

      - name: TESTE 2 - API /api/pro responde
        shell: bash
        run: |
          set -e
          ssh -i ~/.ssh/github_actions "${{ secrets.VM_USER }}@${{ secrets.VM_HOST }}" \
            "curl -fsS --max-time 8 http://127.0.0.1:8095/api/pro | head -c 200 && echo"

      - name: TESTE 3 - TOP10 e HEALTH existem (HTTP 200)
        shell: bash
        run: |
          set -e
          ssh -i ~/.ssh/github_actions "${{ secrets.VM_USER }}@${{ secrets.VM_HOST }}" <<'SSH'
          set -e
          code=$(curl -sS -o /dev/null -w "%{http_code}" --max-time 8 http://127.0.0.1:8095/top10.html)
          echo "TOP10_HTTP_CODE=$code"
          test "$code" = "200"
          curl -fsS --max-time 8 http://127.0.0.1:8095/health
          echo
          SSH
