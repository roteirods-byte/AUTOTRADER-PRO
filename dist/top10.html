<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>AUTOTRADER-PRO — TOP 10</title>
  <style>
    :root{
      --bg:#062d3b; --panel:#083243; --text:#e8f0f2; --muted:#9bb7c3;
      --orange:#ff8a00; --green:#00e676; --red:#ff3355; --yellow:#ffcc00;
      --bluebtn:#1aa3a3; --line: rgba(255,255,255,.08);
    }
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;}
    .wrap{max-width:1180px;margin:24px auto;padding:0 14px;}
    .card{background:var(--panel);border-radius:14px;padding:18px 18px 14px;box-shadow:0 10px 30px rgba(0,0,0,.25);}
    .top{display:flex;justify-content:space-between;gap:12px;align-items:flex-start;flex-wrap:wrap;}
    h1{margin:0;font-size:26px;}
    .sub{margin-top:6px;color:var(--muted);font-size:12px;line-height:1.35;}
    .right{display:flex;flex-direction:column;align-items:flex-end;gap:10px;}
    .updated{color:var(--orange);font-weight:800;font-size:13px;}
    .btns{display:flex;gap:10px;}
    .btn{border:1px solid rgba(255,255,255,.18);background:transparent;color:var(--text);padding:8px 12px;border-radius:10px;font-weight:800;cursor:pointer}
    .btn.primary{background:var(--bluebtn);border-color:transparent;}
    table{width:100%;border-collapse:collapse;margin-top:14px;font-size:12px;}
    th{color:var(--orange);text-align:left;padding:10px 8px;border-bottom:1px solid var(--line);}
    td{padding:9px 8px;border-bottom:1px solid var(--line);white-space:nowrap;}
    .side-long{color:var(--green);font-weight:900;}
    .side-short{color:var(--red);font-weight:900;}
    .gain-pos{color:var(--green);font-weight:900;}
    .gain-neg{color:var(--red);font-weight:900;}
    .zona-verde{color:var(--green);font-weight:900;}
    .zona-amarela{color:var(--yellow);font-weight:900;}
    .risco-baixo{color:var(--green);font-weight:900;}
    .risco-medio{color:var(--yellow);font-weight:900;}
    .prio-alta{color:var(--green);font-weight:900;}
    .prio-media{color:var(--yellow);font-weight:900;}
    .prio-baixa{color:var(--red);font-weight:900;}
    .muted{color:var(--muted);}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <div>
          <h1>AUTOTRADER-PRO — TOP 10</h1>
          <div class="sub">
            Painel único (PRO) — dados em <b>/api/top10</b><br/>
            Metodologia (resumo): ranking por ASSERT% (com confiabilidade n), depois GANHO%. PRAZO = dias estimados até o ALVO.
          </div>
          <div style="margin-top:10px">
            <button class="btn primary" id="btnAtualizar">ATUALIZAR</button>
          </div>
        </div>
        <div class="right">
          <div class="updated" id="updated">Atualizado: —</div>
          <div class="btns">
            <button class="btn" onclick="location.href='full.html'">PAINEL</button>
            <button class="btn" onclick="location.href='audit.html'">AUDITORIA</button>
          </div>
          <div class="sub muted" id="metaLine">GAIN_MIN: — • Volatilidade BTC: —</div>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th>PAR</th><th>SIDE</th><th>PREÇO</th><th>ALVO</th><th>GANHO %</th><th>ASSERT %</th><th>PRAZO</th>
            <th>ZONA</th><th>RISCO</th><th>PRIORIDADE</th><th>DATA</th><th>HORA</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="12" class="muted">Carregando…</td></tr>
        </tbody>
      </table>
    </div>
  </div>

<script>
const fmtNum = (v, dec=4) => {
  const n = Number(String(v).replace(",", "."));
  if (!Number.isFinite(n)) return "0";
  return n.toFixed(dec);
};
const fmtPct = (v) => {
  const n = Number(String(v).replace(",", "."));
  if (!Number.isFinite(n)) return "—";
  return n.toFixed(2) + "%";
};
const clsSide = (s) => {
  s = (s||"").toUpperCase();
  if (s.includes("LONG")) return "side-long";
  if (s.includes("SHORT")) return "side-short";
  return "";
};
const clsZona = (z) => {
  z = (z||"").toUpperCase();
  if (z.includes("VERDE")) return "zona-verde";
  if (z.includes("AMARELA")) return "zona-amarela";
  return "";
};
const clsRisco = (r) => {
  r = (r||"").toUpperCase();
  if (r.includes("BAIXO")) return "risco-baixo";
  if (r.includes("MÉDIO") || r.includes("MEDIO")) return "risco-medio";
  return "";
};
const clsPrio = (p) => {
  p = (p||"").toUpperCase();
  if (p.includes("ALTA")) return "prio-alta";
  if (p.includes("MÉDIA") || p.includes("MEDIA")) return "prio-media";
  if (p.includes("BAIXA")) return "prio-baixa";
  return "";
};

async function load() {
  const tb = document.getElementById("tbody");
  tb.innerHTML = `<tr><td colspan="12" class="muted">Carregando…</td></tr>`;
  try{
    const r = await fetch("/api/top10?ts=" + Date.now(), {cache:"no-store"});
    const j = await r.json();

    const up = (j && j.meta && j.meta.updated_brt) ? j.meta.updated_brt : "—";
    document.getElementById("updated").textContent = "Atualizado: " + up;

    const items = (j && j.items) ? j.items : [];
    if (!items.length){
      tb.innerHTML = `<tr><td colspan="12" class="muted">Sem dados no momento.</td></tr>`;
      return;
    }

    tb.innerHTML = items.map(it => {
      const side = (it.side||"").toUpperCase();
      const ganho = Number(String(it.ganho ?? it.ganho_pct ?? it.ganho_percent ?? it.ganhoPerc ?? "").replace(",", "."));
      const assertv = it.assert ?? it.assert_pct ?? it.assert_percent ?? it.assertPerc;
      return `<tr>
        <td>${it.par ?? it.pair ?? "—"}</td>
        <td class="${clsSide(side)}">${side || "—"}</td>
        <td>${fmtNum(it.preco ?? it.price ?? it.px ?? 0, 4)}</td>
        <td>${fmtNum(it.alvo ?? it.target ?? it.tp ?? 0, 4)}</td>
        <td class="${Number.isFinite(ganho) && ganho >= 0 ? "gain-pos":"gain-neg"}">${fmtPct(ganho)}</td>
        <td class="gain-pos">${fmtPct(assertv)}</td>
        <td>${it.prazo ?? "—"}</td>
        <td class="${clsZona(it.zona)}">${it.zona ?? "—"}</td>
        <td class="${clsRisco(it.risco)}">${it.risco ?? "—"}</td>
        <td class="${clsPrio(it.prioridade)}">${it.prioridade ?? "—"}</td>
        <td>${it.data ?? "—"}</td>
        <td>${it.hora ?? "—"}</td>
      </tr>`;
    }).join("");
  }catch(e){
    tb.innerHTML = `<tr><td colspan="12" class="muted">Erro ao carregar. Atualize a página.</td></tr>`;
  }
}
document.getElementById("btnAtualizar").addEventListener("click", load);
load();
</script>
</body>
</html>
